<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0f1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SIGT">
  <link rel="manifest" href="manifest.json">
  <title>SIGT ¬∑ Incidencias</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060b18;
      --surface: #0d1426;
      --surface2: #131d35;
      --border: #1e2d4a;
      --text: #e8edf8;
      --muted: #6b7fa3;
      --accent: #f97316;
      --accent-dim: rgba(249,115,22,0.15);
      --s1: #ef4444;
      --s1-dim: rgba(239,68,68,0.15);
      --s2: #f97316;
      --s2-dim: rgba(249,115,22,0.15);
      --s3: #22c55e;
      --s3-dim: rgba(34,197,94,0.15);
      --radius: 16px;
      --radius-sm: 10px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.04) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.04) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    #app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; min-height: 100dvh; display: flex; flex-direction: column; }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    .header {
      padding: 20px 20px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(6,11,24,0.9);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 20px rgba(249,115,22,0.3);
    }

    .logo-text {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-sub {
      font-family: 'Space Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .history-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    .history-btn:active { transform: scale(0.92); background: var(--surface); }

    /* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
    .main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

    /* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
    .screen { display: none; flex-direction: column; gap: 16px; animation: fadeIn 0.3s ease; }
    .screen.active { display: flex; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* ‚îÄ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ‚îÄ */
    .section-title {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ‚îÄ PRIORITY SELECTOR ‚îÄ‚îÄ‚îÄ */
    .priority-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .priority-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .priority-card::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .priority-card.s1::before { background: var(--s1-dim); }
    .priority-card.s2::before { background: var(--s2-dim); }
    .priority-card.s3::before { background: var(--s3-dim); }

    .priority-card:active { transform: scale(0.95); }

    .priority-card.selected.s1 { border-color: var(--s1); box-shadow: 0 0 20px rgba(239,68,68,0.2); }
    .priority-card.selected.s2 { border-color: var(--s2); box-shadow: 0 0 20px rgba(249,115,22,0.2); }
    .priority-card.selected.s3 { border-color: var(--s3); box-shadow: 0 0 20px rgba(34,197,94,0.2); }
    .priority-card.selected::before { opacity: 1; }

    .p-badge {
      font-family: 'Space Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      display: block;
      margin-bottom: 4px;
    }

    .s1 .p-badge { color: var(--s1); }
    .s2 .p-badge { color: var(--s2); }
    .s3 .p-badge { color: var(--s3); }

    .p-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
    }

    .p-desc {
      font-size: 9px;
      color: var(--muted);
      margin-top: 4px;
      display: block;
      line-height: 1.3;
    }

    /* ‚îÄ‚îÄ‚îÄ CATEGORY GRID ‚îÄ‚îÄ‚îÄ */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .cat-card {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cat-card:active { transform: scale(0.96); }
    .cat-card.selected { border-color: var(--accent); background: var(--accent-dim); }

    .cat-icon { font-size: 22px; flex-shrink: 0; }
    .cat-text { flex: 1; }
    .cat-name { font-size: 12px; font-weight: 700; display: block; }
    .cat-code { display: inline-block; background: var(--accent); color: white; font-family: Space Mono, monospace; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 4px; margin-right: 4px; vertical-align: middle; }
    .cat-sub { font-size: 10px; color: var(--muted); display: block; margin-top: 1px; }

    /* ‚îÄ‚îÄ‚îÄ FORM FIELDS ‚îÄ‚îÄ‚îÄ */
    .field { display: flex; flex-direction: column; gap: 6px; }

    .field label {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .field label .req { color: var(--accent); }

    .field input, .field select, .field textarea {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    .field select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7fa3' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    .field input:focus, .field select:focus, .field textarea:focus {
      border-color: var(--accent);
    }

    .field textarea {
      resize: none;
      min-height: 80px;
      line-height: 1.5;
    }

    .field input::placeholder, .field textarea::placeholder { color: var(--muted); }

    /* ‚îÄ‚îÄ‚îÄ QUICK SYMPTOMS ‚îÄ‚îÄ‚îÄ */
    .symptom-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--muted);
    }

    .pill:active { transform: scale(0.95); }
    .pill.selected { border-color: var(--accent); background: var(--accent-dim); color: var(--text); }

    /* ‚îÄ‚îÄ‚îÄ STATUS ROW ‚îÄ‚îÄ‚îÄ */
    .status-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .status-btn {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 600;
    }

    .status-btn:active { transform: scale(0.96); }
    .status-btn.yes.selected { border-color: var(--s1); background: var(--s1-dim); color: var(--s1); }
    .status-btn.no.selected { border-color: var(--s3); background: var(--s3-dim); color: var(--s3); }

    /* ‚îÄ‚îÄ‚îÄ SUBMIT BUTTON ‚îÄ‚îÄ‚îÄ */
    .submit-btn {
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: white;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 800;
      padding: 18px;
      width: 100%;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(249,115,22,0.3);
      position: relative;
      overflow: hidden;
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    }

    .submit-btn:active { transform: scale(0.97); box-shadow: 0 4px 12px rgba(249,115,22,0.2); }
    .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ‚îÄ‚îÄ‚îÄ PRIORITY INDICATOR BAR ‚îÄ‚îÄ‚îÄ */
    .mvd-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mvd-progress {
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .mvd-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .mvd-label {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      white-space: nowrap;
    }

    .mvd-count {
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ‚îÄ SUCCESS SCREEN ‚îÄ‚îÄ‚îÄ */
    .success-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 20px;
      padding: 40px 20px;
      animation: fadeIn 0.4s ease;
      min-height: 80dvh;
    }

    .success-screen.active { display: flex; }

    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      animation: pulse 0.5s ease;
    }

    @keyframes pulse {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .success-icon.s1 { background: var(--s1-dim); border: 2px solid var(--s1); }
    .success-icon.s2 { background: var(--s2-dim); border: 2px solid var(--s2); }
    .success-icon.s3 { background: var(--s3-dim); border: 2px solid var(--s3); }

    .ticket-id {
      font-family: 'Space Mono', monospace;
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 2px;
    }

    .ticket-summary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      width: 100%;
      text-align: left;
    }

    .ticket-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .ticket-row:last-child { border-bottom: none; }
    .ticket-row .t-key { color: var(--muted); font-size: 11px; font-family: 'Space Mono', monospace; }
    .ticket-row .t-val { font-weight: 700; }

    .badge-s1 { color: var(--s1); }
    .badge-s2 { color: var(--s2); }
    .badge-s3 { color: var(--s3); }

    .new-btn {
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      font-weight: 700;
      padding: 16px 24px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .new-btn:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ‚îÄ HISTORY SCREEN ‚îÄ‚îÄ‚îÄ */
    .history-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 4px;
    }

    .back-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      flex-shrink: 0;
    }

    .ticket-item {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .ticket-item .t-priority {
      font-family: 'Space Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      width: 32px;
      flex-shrink: 0;
      text-align: center;
    }

    .ticket-item .t-info { flex: 1; }
    .ticket-item .t-id { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }
    .ticket-item .t-cat { font-size: 14px; font-weight: 700; margin: 2px 0; }
    .ticket-item .t-salon { font-size: 12px; color: var(--muted); }
    .ticket-item .t-time { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); text-align: right; flex-shrink: 0; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--muted);
    }

    .empty-state .e-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 14px; }

    /* ‚îÄ‚îÄ‚îÄ STEP INDICATOR ‚îÄ‚îÄ‚îÄ */
    .steps {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .step-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s;
    }

    .step-dot.active { background: var(--accent); width: 18px; border-radius: 3px; }
    .step-dot.done { background: var(--s3); }

    .whatsapp-btn {
      background: #25D366;
      border: none;
      border-radius: var(--radius);
      color: white;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 800;
      padding: 18px;
      width: 100%;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 24px rgba(37,211,102,0.3);
    }
    .whatsapp-btn:active { transform: scale(0.97); box-shadow: 0 4px 12px rgba(37,211,102,0.15); }


    /* ‚îÄ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ‚îÄ */
    .photo-upload-area {
      background: var(--surface);
      border: 1.5px dashed var(--border);
      border-radius: var(--radius-sm);
      min-height: 100px;
      cursor: pointer;
      transition: border-color 0.2s;
      overflow: hidden;
    }
    .photo-upload-area:active { border-color: var(--accent); }
    .photo-upload-area.has-photos { border-style: solid; border-color: var(--accent); }

    .photo-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 4px;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      padding: 4px;
    }

    .photo-thumb {
      position: relative;
      aspect-ratio: 4/3;
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface2);
    }

    .photo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-thumb .remove-photo {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .photo-action-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-family: Syne, sans-serif;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
      flex: 1;
      transition: all 0.15s;
    }
    .photo-action-btn:active { background: var(--surface); border-color: var(--accent); color: var(--text); }

    .photo-count-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      color: var(--accent);
      font-family: Space Mono, monospace;
      margin-top: 4px;
    }
    /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ‚îÄ‚îÄ‚îÄ INSTALL BANNER ‚îÄ‚îÄ‚îÄ */
    .install-banner {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      display: none;
    }

    .install-banner button {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 11px;
      padding: 6px 12px;
      cursor: pointer;
      margin-left: auto;
      white-space: nowrap;
    }

    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .notice {
      background: var(--s2-dim);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--s2);
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .pin-dot {
      width: 16px; height: 16px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: transparent;
      transition: all 0.15s;
    }
    .pin-dot.filled { background: var(--accent); border-color: var(--accent); }
    .pin-dot.error { background: var(--s1); border-color: var(--s1); }

    .pin-key {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-family: Syne, sans-serif;
      font-size: 22px;
      font-weight: 700;
      padding: 18px;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .pin-key:active { transform: scale(0.92); background: var(--surface2); border-color: var(--accent); }
    .pin-key.pressed { transform: scale(0.92); background: var(--surface2); border-color: var(--accent); }
    .pin-key { touch-action: manipulation; user-select: none; -webkit-user-select: none; }
  </style>
</head>
<body>
<div id="app">
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;gap:24px;">
    <div style="text-align:center;">
      <div style="width:64px;height:64px;background:var(--accent);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;box-shadow:0 0 30px rgba(249,115,22,0.4);">‚ö°</div>
      <div style="font-size:26px;font-weight:800;letter-spacing:-0.5px;"><span style="color:var(--accent)">SI</span>GT ¬∑ Grupo AC</div>
      <div style="font-family:Space Mono,monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-top:4px;">Acceso Autorizado</div>
    </div>

    <div style="width:100%;max-width:320px;display:flex;flex-direction:column;gap:12px;">
      <div style="font-family:Space Mono,monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;">Introduce tu PIN</div>
      <div id="pinDots" style="display:flex;gap:12px;justify-content:center;margin:8px 0;">
        <div class="pin-dot" id="pd0"></div>
        <div class="pin-dot" id="pd1"></div>
        <div class="pin-dot" id="pd2"></div>
        <div class="pin-dot" id="pd3"></div>
      </div>
      <div id="pinError" style="text-align:center;font-size:12px;color:var(--s1);min-height:18px;"></div>

      <!-- Teclado num√©rico -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:4px;" id="pinKeypad">
        <button class="pin-key" ontouchstart="handlePinTouch(event,1)" onclick="pinInput(1)">1</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,2)" onclick="pinInput(2)">2</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,3)" onclick="pinInput(3)">3</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,4)" onclick="pinInput(4)">4</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,5)" onclick="pinInput(5)">5</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,6)" onclick="pinInput(6)">6</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,7)" onclick="pinInput(7)">7</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,8)" onclick="pinInput(8)">8</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,9)" onclick="pinInput(9)">9</button>
        <button class="pin-key" ontouchstart="handlePinClearTouch(event)" onclick="pinClear()" style="color:var(--muted);font-size:18px;">‚å´</button>
        <button class="pin-key" ontouchstart="handlePinTouch(event,0)" onclick="pinInput(0)">0</button>
        <button class="pin-key" style="opacity:0;pointer-events:none;"></button>
      </div>

      <div id="lockMsg" style="text-align:center;font-size:11px;color:var(--s1);min-height:16px;font-family:Space Mono,monospace;"></div>
    </div>
  </div>


  <!-- HEADER -->
  <div class="header">
    <div class="logo">
      <div class="logo-icon">‚ö°</div>
      <div>
        <div class="logo-text"><span>SI</span>GT <span style="font-size:14px;font-weight:600;color:var(--muted)">¬∑ Grupo AC</span></div>
        <div class="header-sub">Gesti√≥n T√©cnica SAT</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="steps" id="stepDots">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
      </div>
      <button class="history-btn" onclick="showHistory()" title="Historial">üìã</button>
      <button class="history-btn" onclick="checkSettingsPassword()" title="Configuraci√≥n">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main" id="mainContent">

    <!-- ‚îÄ‚îÄ STEP 1: PRIORIDAD Y CATEGOR√çA ‚îÄ‚îÄ -->
    <div class="screen active" id="screen1">

      <div id="installBanner" class="install-banner">
        üì≤ <span>A√±ade SIGT a tu pantalla de inicio para acceso r√°pido</span>
        <button id="installBtn">Instalar</button>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:12px">‚ë† Nivel de urgencia</div>
        <div class="priority-grid">
          <div class="priority-card s1" onclick="selectPriority('S1', this)">
            <span class="p-badge">S1</span>
            <span class="p-label">Cr√≠tica</span>
            <span class="p-desc">M√°quina parada, p√©rdida recaudaci√≥n</span>
          </div>
          <div class="priority-card s2" onclick="selectPriority('S2', this)">
            <span class="p-badge">S2</span>
            <span class="p-label">Alta</span>
            <span class="p-desc">Degradada, funciona con problemas</span>
          </div>
          <div class="priority-card s3" onclick="selectPriority('S3', this)">
            <span class="p-badge">S3</span>
            <span class="p-label">Normal</span>
            <span class="p-desc">Mantenimiento o baja prioridad</span>
          </div>
        </div>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:12px">‚ë° Tipo de aver√≠a</div>
        <div class="category-grid" id="categoryGrid">
          <div class="cat-card" onclick="selectCategory('C01 ¬∑ Energ√≠a / Arranque', '‚ö°', this)">
            <span class="cat-icon">‚ö°</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C01</span> Energ√≠a</span>
              <span class="cat-sub">No enciende, reinicios, quemado</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C02 ¬∑ Pantalla / V√≠deo / Audio', 'üñ•Ô∏è', this)">
            <span class="cat-icon">üñ•Ô∏è</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C02</span> Pantalla</span>
              <span class="cat-sub">Negra, No Signal, colores, audio</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C03 ¬∑ Billetero / MDB', 'üíµ', this)">
            <span class="cat-icon">üíµ</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C03</span> Billetero</span>
              <span class="cat-sub">No acepta billetes, luz roja</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C04 ¬∑ Monedas / Hopper', 'ü™ô', this)">
            <span class="cat-icon">ü™ô</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C04</span> Monedas</span>
              <span class="cat-sub">No paga premios, atasco hopper</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C05 ¬∑ Pagos / Devoluci√≥n', 'üí∞', this)">
            <span class="cat-icon">üí∞</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C05</span> Pagos</span>
              <span class="cat-sub">Paga de m√°s/menos, error l√≥gico</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C06 ¬∑ Puertas / Cerraduras', 'üîë', this)">
            <span class="cat-icon">üîë</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C06</span> Accesos</span>
              <span class="cat-sub">Llave rota, cerradura, puerta</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C07 ¬∑ Red / Telemetr√≠a', 'üì°', this)">
            <span class="cat-icon">üì°</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C07</span> Red</span>
              <span class="cat-sub">Offline, sin conexi√≥n, SAS</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C08 ¬∑ Contadoras / Sensores', 'üî¢', this)">
            <span class="cat-icon">üî¢</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C08</span> Sensores</span>
              <span class="cat-sub">Error conteo, atasco CIS</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C09 ¬∑ Software / Sistema', 'üíª', this)">
            <span class="cat-icon">üíª</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C09</span> Software</span>
              <span class="cat-sub">Blue screen, error SO, bloqueo</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C10 ¬∑ Botones / Iluminaci√≥n', 'üí°', this)">
            <span class="cat-icon">üí°</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C10</span> Botones / Luz</span>
              <span class="cat-sub">LEDs, botonera, toppers</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C11 ¬∑ Efectivo / Discrepancias', 'üè¶', this)">
            <span class="cat-icon">üè¶</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C11</span> Efectivo</span>
              <span class="cat-sub">Descuadre caja, bolsa rota</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C12 ¬∑ Da√±o F√≠sico / Vandalismo', 'üõ°Ô∏è', this)">
            <span class="cat-icon">üõ°Ô∏è</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C12</span> Da√±o F√≠sico</span>
              <span class="cat-sub">Cristal roto, l√≠quidos, golpes</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C13 ¬∑ Multiaver√≠a Sala', 'üö®', this)">
            <span class="cat-icon">üö®</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C13</span> Multiaver√≠a</span>
              <span class="cat-sub">Varias m√°quinas, evento com√∫n</span>
            </div>
          </div>
          <div class="cat-card" onclick="selectCategory('C14 ¬∑ Preventivo Programado', 'üîß', this)">
            <span class="cat-icon">üîß</span>
            <div class="cat-text">
              <span class="cat-name"><span class="cat-code">C14</span> Preventivo</span>
              <span class="cat-sub">Mantenimiento planificado</span>
            </div>
          </div>
        </div>
      </div>

      <button class="submit-btn" id="nextBtn1" onclick="goToStep2()" disabled>
        Continuar ‚Üí Datos MVD
      </button>
    </div>

    <!-- ‚îÄ‚îÄ STEP 2: DATOS MVD ‚îÄ‚îÄ -->
    <div class="screen" id="screen2">

      <div id="priorityNotice" class="notice">
        <span>‚ö†Ô∏è</span>
        <span id="priorityNoticeText"></span>
      </div>

      <div class="field">
        <label>Sal√≥n / Sala <span class="req">*</span></label>
        <input type="text" id="salon" placeholder="Nombre del sal√≥n" autocomplete="off">
      </div>

      <div class="field-row">
        <div class="field">
          <label>Modelo m√°quina <span class="req">*</span></label>
          <input type="text" id="modelo" placeholder="ej. Apex 4" autocomplete="off">
        </div>
        <div class="field">
          <label>N¬∫ Serie <span class="req">*</span></label>
          <input type="text" id="serie" placeholder="ej. 12345" autocomplete="off">
        </div>
      </div>

      <div class="field">
        <label>S√≠ntoma principal <span class="req">*</span></label>
        <div class="symptom-pills" id="symptomPills" style="margin-bottom:8px"></div>
        <textarea id="sintoma" placeholder="Describe el problema con el mayor detalle posible..." rows="3"></textarea>
      </div>

      <div class="field">
        <label>Errores en pantalla</label>
        <input type="text" id="errores" placeholder="ej. ERR-045, pantalla roja..." autocomplete="off">
      </div>

      <div class="field">
        <label>¬øAfecta a la recaudaci√≥n?</label>
        <div class="status-row">
          <button class="status-btn yes" onclick="toggleRecaudacion(true, this)">üî¥ S√≠, para</button>
          <button class="status-btn no" onclick="toggleRecaudacion(false, this)">üü¢ No afecta</button>
        </div>
      </div>

      <div class="field">
        <label>¬øCu√°ndo empez√≥?</label>
        <select id="inicio">
          <option value="">Selecciona...</option>
          <option value="Ahora mismo">Ahora mismo</option>
          <option value="Hace menos de 1 hora">Hace menos de 1 hora</option>
          <option value="Hoy">Hoy</option>
          <option value="Ayer">Ayer</option>
          <option value="Esta semana">Esta semana</option>
          <option value="No se sabe">No se sabe</option>
        </select>
      </div>

      <div class="field">
        <label>Pasos ya probados</label>
        <input type="text" id="pasos" placeholder="ej. Reinicio, revisi√≥n billetero..." autocomplete="off">
      </div>

      <div class="field">
        <label>Fotograf√≠as <span style="color:var(--muted);font-size:9px;">(m√°x. 4 fotos)</span></label>
        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
          <input type="file" id="photoInput" accept="image/*" multiple capture="environment" style="display:none" onchange="handlePhotos(this)">
          <div class="photo-placeholder" id="photoPlaceholder">
            <span style="font-size:28px;">üì∏</span>
            <span style="font-size:13px;font-weight:700;margin-top:6px;">Toca para a√±adir fotos</span>
            <span style="font-size:11px;color:var(--muted);">C√°mara o galer√≠a ¬∑ m√°x. 4 im√°genes</span>
          </div>
          <div class="photo-grid" id="photoGrid" style="display:none;"></div>
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;">
          <button type="button" class="photo-action-btn" onclick="event.stopPropagation();document.getElementById('photoInput').click()">üì∑ C√°mara</button>
          <button type="button" class="photo-action-btn" onclick="event.stopPropagation();clearPhotos()">üóëÔ∏è Borrar todo</button>
        </div>
      </div>

      <div class="field">
        <label>Tu nombre / empleado <span class="req">*</span></label>
        <input type="text" id="empleado" placeholder="Tu nombre completo" autocomplete="off">
      </div>

      <div class="field">
        <label>üì± Tu tel√©fono personal
          <span id="telPersonalGuardado" style="font-family:Space Mono,monospace;font-size:9px;color:var(--s3);margin-left:6px;"></span>
        </label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="tel" id="telPersonal" placeholder="ej. 600 123 456" autocomplete="tel" style="flex:1;">
          <button type="button" class="photo-action-btn" style="max-width:80px;" onclick="guardarTelPersonal()">üíæ Guardar</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px;">Se guardar√° en este m√≥vil para futuros tickets</div>
      </div>

      <div class="field">
        <label>üìû Tel√©fono de la sala
          <span id="telSalaGuardado" style="font-family:Space Mono,monospace;font-size:9px;color:var(--s3);margin-left:6px;"></span>
        </label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="tel" id="telSala" placeholder="ej. 922 000 000" autocomplete="tel" style="flex:1;">
          <button type="button" class="photo-action-btn" style="max-width:80px;" onclick="guardarTelSala()">üíæ Guardar</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px;">Tel√©fono fijo de contacto de esta sala</div>
      </div>

      <div class="mvd-bar">
        <div class="mvd-progress"><div class="mvd-fill" id="mvdFill" style="width:0%"></div></div>
        <div class="mvd-label">MVD completo</div>
        <div class="mvd-count" id="mvdCount">0/4</div>
      </div>

      <div style="display:flex;gap:10px;">
        <button class="new-btn" style="max-width:80px;" onclick="goToStep1()">‚Üê Volver</button>
        <button class="submit-btn" id="submitBtn" onclick="submitTicket()">
          ‚ö° Abrir Incidencia
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ -->
    <div class="success-screen" id="successScreen">
      <div class="success-icon" id="successIcon">‚úì</div>
      <div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px;font-family:'Space Mono',monospace;">TICKET ABIERTO</div>
        <div class="ticket-id" id="ticketId">---</div>
      </div>
      <div class="ticket-summary" id="ticketSummary"></div>
      <button class="whatsapp-btn" onclick="sendWhatsApp(currentTicket)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp al SAT
      </button>
      <button class="new-btn" onclick="resetForm()">+ Nueva Incidencia</button>
    </div>


    <!-- ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ -->
    <div class="screen" id="settingsScreen" style="display:none;">
      <div class="history-header">
        <button class="back-btn" onclick="hideSettings()">‚Üê</button>
        <div>
          <div style="font-size:18px;font-weight:800;">Configuraci√≥n</div>
          <div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;">Integraci√≥n Google Sheets</div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="font-size:28px;">üìä</div>
          <div>
            <div style="font-size:15px;font-weight:700;">Google Sheets</div>
            <div id="sheetsStatus" style="font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;margin-top:2px;">No configurado</div>
          </div>
          <div id="sheetsIndicator" style="width:10px;height:10px;border-radius:50%;background:var(--border);margin-left:auto;flex-shrink:0;"></div>
        </div>
        <div class="field">
          <label>URL del Apps Script <span class="req">*</span></label>
          <textarea id="scriptUrlInput" placeholder="https://script.google.com/macros/s/XXXXX.../exec" rows="3" style="font-family:'Space Mono',monospace;font-size:11px;word-break:break-all;"></textarea>
        </div>
        <button class="submit-btn" onclick="saveScriptUrl()" style="padding:14px;">üíæ Guardar URL</button>
        <button id="testBtn" class="new-btn" onclick="testConnection()" style="padding:12px;font-size:13px;">üîå Probar conexi√≥n</button>
        <div id="testResult" style="display:none;padding:10px 12px;border-radius:var(--radius-sm);font-size:12px;"></div>
      </div>

      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
        <div style="font-size:13px;font-weight:700;margin-bottom:8px;">üìã C√≥mo configurar</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.8;">
          1. Abre Google Sheets en tu Drive<br>
          2. <b style="color:var(--text)">Extensiones ‚Üí Apps Script</b><br>
          3. Pega el c√≥digo del script<br>
          4. <b style="color:var(--text)">Implementar ‚Üí Nueva implementaci√≥n</b><br>
          5. Tipo: <b style="color:var(--text)">Aplicaci√≥n web</b><br>
          6. Ejecutar como: <b style="color:var(--text)">Yo (tu cuenta)</b><br>
          7. Acceso: <b style="color:var(--text)">Cualquier persona</b><br>
          8. Copia la URL y p√©gala arriba
        </div>
      </div>

      <div style="background:var(--s2-dim);border:1px solid rgba(249,115,22,0.3);border-radius:var(--radius);padding:14px;">
        <div style="font-size:12px;color:var(--s2);line-height:1.6;">
          ‚ö†Ô∏è Sin URL la app funciona en <b>modo local</b>. Los IDs no ser√°n correlativos ni quedar√°n registrados en el Sheet.
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ -->
    <div class="screen" id="historyScreen" style="display:none;">
      <div class="history-header">
        <button class="back-btn" onclick="hideHistory()">‚Üê</button>
        <div>
          <div style="font-size:18px;font-weight:800;">Mis Incidencias</div>
          <div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;" id="historyCount"></div>
        </div>
      </div>
      <div id="historyList"></div>
    </div>

  </div>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ WHATSAPP ‚îÄ‚îÄ‚îÄ
  let currentTicket = null;

  function sendWhatsApp(ticket) {
    const rec = ticket.recaudacion === true ? 'S√ç ‚ö†Ô∏è' : ticket.recaudacion === false ? 'No' : 'No indicado';
    const lines = [
      `üö® *INCIDENCIA SIGT* üö®`,
      ``,
      `üìã *Ticket:* ${ticket.id}`,
      `üî¥ *Prioridad:* ${ticket.priority} ${ticket.priority === 'S1' ? '‚Äî CR√çTICA' : ticket.priority === 'S2' ? '‚Äî ALTA' : '‚Äî NORMAL'}`,
      `üîß *Tipo:* ${ticket.categoryIcon} ${ticket.category}`,
      ``,
      `üìç *Sal√≥n:* ${ticket.salon}`,
      `üé∞ *M√°quina:* ${ticket.modelo}`,
      `üî¢ *Serie:* ${ticket.serie}`,
      ``,
      `‚ö†Ô∏è *S√≠ntoma:* ${ticket.sintoma}`,
      ticket.errores ? `‚ùå *Errores:* ${ticket.errores}` : null,
      `üí∞ *Recaudaci√≥n afectada:* ${rec}`,
      ticket.inicio ? `üïê *Inicio:* ${ticket.inicio}` : null,
      ticket.pasos ? `üîÅ *Pasos probados:* ${ticket.pasos}` : null,
      ``,
      `üë§ *Empleado:* ${ticket.empleado || 'No indicado'}`,
      ticket.telPersonal ? `üì± *Tel. personal:* ${ticket.telPersonal}` : null,
      ticket.telSala ? `üìû *Tel. sala:* ${ticket.telSala}` : null,
      ticket.numFotos > 0 && ticket.folderUrl ? `üì∏ *Fotos en Drive:* ${ticket.folderUrl}` : (ticket.numFotos > 0 ? `üì∏ *Fotos adjuntas:* ${ticket.numFotos}` : null),
      `‚è∞ *Hora:* ${new Date(ticket.timestamp).toLocaleString('es-ES')}`,
    ].filter(l => l !== null).join('\n');

    const encoded = encodeURIComponent(lines);
    window.open(`https://wa.me/34646365886?text=${encoded}`, '_blank');
  }

  // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
  const state = {
    priority: null,
    category: null,
    categoryIcon: null,
    recaudacion: null,
    currentStep: 1
  };

  // ‚îÄ‚îÄ‚îÄ SYMPTOM SUGGESTIONS PER CATEGORY ‚îÄ‚îÄ‚îÄ
  const symptoms = {
    'C01 ¬∑ Energ√≠a / Arranque': ['No enciende', 'Reinicios constantes (boot loop)', 'Olor a quemado', 'Humo o chispas', 'Se apaga sola', 'Fallo fuente alimentaci√≥n'],
    'C02 ¬∑ Pantalla / V√≠deo / Audio': ['Pantalla negra', 'No Signal', 'Colores distorsionados', 'Imagen con glitches', 'Sin sonido', 'Retroiluminaci√≥n apagada'],
    'C03 ¬∑ Billetero / MDB': ['No acepta billetes', 'Escupe el billete', 'Luz roja encendida', 'Atasco en boca de entrada', 'Billetero apagado', 'Error de lectura'],
    'C04 ¬∑ Monedas / Hopper': ['No acepta monedas', 'No paga premios', 'Ruido de motor sin salida', 'Atasco f√≠sico en canal', 'Hopper vac√≠o'],
    'C05 ¬∑ Pagos / Devoluci√≥n': ['Paga de menos', 'Paga de m√°s', 'Se queda pensando al pagar', 'Error l√≥gico contabilidad', 'No devuelve cambio'],
    'C06 ¬∑ Puertas / Cerraduras': ['Llave rota dentro del bomb√≠n', 'Cerradura forzada', 'Puerta no cierra bien', 'No gira la llave'],
    'C07 ¬∑ Red / Telemetr√≠a': ['M√°quina offline', 'Error de enlace con servidor', 'Fallo contabilidad remota', 'Toda la sala sin red', 'Una sola m√°quina sin red'],
    'C08 ¬∑ Contadoras / Sensores': ['Error de conteo', 'Atasco en contadora', 'Sensores sucios', 'Rodillos desgastados'],
    'C09 ¬∑ Software / Sistema': ['Pantalla azul', 'Error de sistema', 'Bloqueo al entrar men√∫', 'P√©rdida de configuraci√≥n', 'Juego no arranca'],
    'C10 ¬∑ Botones / Iluminaci√≥n': ['Bot√≥n no responde', 'Bot√≥n intermitente', 'LEDs fundidos', 'Topper apagado', 'Tira LED rota'],
    'C11 ¬∑ Efectivo / Discrepancias': ['Descuadre de caja', 'Bolsa rota o sin precinto', 'Falta dinero', 'Problema en transporte de fondos'],
    'C12 ¬∑ Da√±o F√≠sico / Vandalismo': ['Cristal roto', 'L√≠quido vertido sobre m√°quina', 'Golpes o intento de robo', 'Da√±o f√≠sico visible'],
    'C13 ¬∑ Multiaver√≠a Sala': ['Varias m√°quinas ca√≠das', 'Subida de tensi√≥n', 'Corte el√©ctrico general', 'Fallo masivo de red'],
    'C14 ¬∑ Preventivo Programado': ['Revisi√≥n rutina planificada', 'Mantenimiento calendario', 'Checklist preventivo']
  };

  // ‚îÄ‚îÄ‚îÄ PRIORITY SELECT ‚îÄ‚îÄ‚îÄ
  function selectPriority(p, el) {
    state.priority = p;
    document.querySelectorAll('.priority-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    updateNextBtn1();
    navigator.vibrate && navigator.vibrate(30);
  }

  function selectCategory(name, icon, el) {
    state.category = name;
    state.categoryIcon = icon;
    document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    updateNextBtn1();
    navigator.vibrate && navigator.vibrate(20);
    // Alert for critical categories
    const critical = ['C01 ¬∑ Energ√≠a / Arranque', 'C11 ¬∑ Efectivo / Discrepancias', 'C12 ¬∑ Da√±o F√≠sico / Vandalismo'];
    if (critical.includes(name)) {
      const msgs = {
        'C01 ¬∑ Energ√≠a / Arranque': '‚ö° ALERTA S1: Si hay olor a quemado o humo, desenchufa la m√°quina inmediatamente.',
        'C11 ¬∑ Efectivo / Discrepancias': 'üí∞ ALERTA S1: Riesgo patrimonial. Reporta solo datos num√©ricos, sin relatos.',
        'C12 ¬∑ Da√±o F√≠sico / Vandalismo': 'üõ°Ô∏è ALERTA S1: Si hay l√≠quidos, a√≠sla la m√°quina. Riesgo de cortocircuito.'
      };
      showToast(msgs[name]);
    }
  }

  function updateNextBtn1() {
    document.getElementById('nextBtn1').disabled = !(state.priority && state.category);
  }

  // ‚îÄ‚îÄ‚îÄ STEP NAVIGATION ‚îÄ‚îÄ‚îÄ
  function goToStep2() {
    if (!state.priority || !state.category) return;

    // Set symptom pills
    const pills = document.getElementById('symptomPills');
    pills.innerHTML = '';
    const syms = symptoms[state.category] || [];
    syms.forEach(s => {
      const p = document.createElement('div');
      p.className = 'pill';
      p.textContent = s;
      p.onclick = () => {
        p.classList.toggle('selected');
        const txt = document.getElementById('sintoma');
        const selected = [...pills.querySelectorAll('.pill.selected')].map(x => x.textContent).join(', ');
        txt.value = selected;
        updateMVD();
      };
      pills.appendChild(p);
    });

    // Priority notice
    const notices = {
      'S1': 'üî¥ S1 CR√çTICA: Respuesta en menos de 2 horas. Completa el MVD para apertura inmediata.',
      'S2': 'üü† S2 ALTA: Respuesta preferente. El sistema priorizar√° asignaci√≥n con t√©cnico cualificado.',
      'S3': 'üü¢ S3 NORMAL: Se gestionar√° en cola est√°ndar. Incluye toda la informaci√≥n posible.'
    };
    document.getElementById('priorityNoticeText').textContent = notices[state.priority];

    const n = document.getElementById('priorityNotice');
    n.style.borderColor = state.priority === 'S1' ? 'rgba(239,68,68,0.4)' : state.priority === 'S2' ? 'rgba(249,115,22,0.3)' : 'rgba(34,197,94,0.3)';
    n.style.background = state.priority === 'S1' ? 'var(--s1-dim)' : state.priority === 'S2' ? 'var(--s2-dim)' : 'var(--s3-dim)';
    n.style.color = state.priority === 'S1' ? 'var(--s1)' : state.priority === 'S2' ? 'var(--s2)' : 'var(--s3)';

    document.getElementById('screen1').classList.remove('active');
    document.getElementById('screen2').classList.add('active');
    state.currentStep = 2;
    updateDots();

    // Auto-fill contact data
    initPhones();

    // Add listeners for MVD
    ['salon', 'modelo', 'serie', 'sintoma'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateMVD);
    });
    updateMVD();

    window.scrollTo(0, 0);
  }

  function goToStep1() {
    document.getElementById('screen2').classList.remove('active');
    document.getElementById('screen1').classList.add('active');
    state.currentStep = 1;
    updateDots();
  }

  function updateDots() {
    const step = state.currentStep;
    document.getElementById('dot1').className = 'step-dot ' + (step > 1 ? 'done' : step === 1 ? 'active' : '');
    document.getElementById('dot2').className = 'step-dot ' + (step > 2 ? 'done' : step === 2 ? 'active' : '');
    document.getElementById('dot3').className = 'step-dot ' + (step === 3 ? 'active' : '');
  }

  // ‚îÄ‚îÄ‚îÄ MVD PROGRESS ‚îÄ‚îÄ‚îÄ
  function updateMVD() {
    const fields = [
      document.getElementById('salon').value.trim(),
      document.getElementById('modelo').value.trim(),
      document.getElementById('serie').value.trim(),
      document.getElementById('sintoma').value.trim()
    ];
    const filled = fields.filter(f => f.length > 0).length;
    const pct = (filled / 4) * 100;
    document.getElementById('mvdFill').style.width = pct + '%';
    document.getElementById('mvdCount').textContent = filled + '/4';
    document.getElementById('submitBtn').disabled = filled < 4;
  }

  // ‚îÄ‚îÄ‚îÄ RECAUDACION ‚îÄ‚îÄ‚îÄ
  function toggleRecaudacion(val, btn) {
    state.recaudacion = val;
    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');

    // Auto-suggest S1 if recaudacion affected
    if (val && state.priority === 'S3') {
      document.getElementById('priorityNoticeText').textContent += ' ‚ö†Ô∏è La recaudaci√≥n est√° afectada. Considera elevar a S1 o S2.';
    }
  }

  // ‚îÄ‚îÄ‚îÄ GOOGLE SHEETS URL ‚îÄ‚îÄ‚îÄ
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjjIgsbUbAJvoI5_kdtUBIYL3jmNkgzUNBooPq7kOH9up0gxlcTLua6F8laSt34L61/exec';

  function generateLocalId() {
    const d = new Date();
    const pad = n => String(n).padStart(2, '0');
    return `TK-LOCAL-${d.getFullYear().toString().slice(2)}${pad(d.getMonth()+1)}${pad(d.getDate())}-${Math.floor(Math.random()*9000)+1000}`;
  }

  // ‚îÄ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ
  function submitTicket() {
    const salon = document.getElementById('salon').value.trim();
    const modelo = document.getElementById('modelo').value.trim();
    const serie = document.getElementById('serie').value.trim();
    const sintoma = document.getElementById('sintoma').value.trim();

    if (!salon || !modelo || !serie || !sintoma) return;

    const empleado = document.getElementById('empleado').value.trim();
    const telPersonal = document.getElementById('telPersonal').value.trim();
    const telSala = document.getElementById('telSala').value.trim();
    if (empleado) localStorage.setItem('sigt_empleado', empleado);
    if (telPersonal) localStorage.setItem('sigt_tel_personal', telPersonal);
    if (telSala) localStorage.setItem('sigt_tel_sala', telSala);

    const payload = {
      priority: state.priority,
      category: state.category,
      categoryIcon: state.categoryIcon,
      salon, modelo, serie, sintoma,
      errores: document.getElementById('errores').value.trim(),
      inicio: document.getElementById('inicio').value,
      pasos: document.getElementById('pasos').value.trim(),
      recaudacion: state.recaudacion,
      empleado,
      telPersonal,
      telSala,
      numFotos: photoFiles.length
    };

    // Show loading state
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span style="opacity:0.7">‚è≥ Registrando...</span>';

    let ticketId, ticketNumero;

    // Encode photos to base64 and send everything to Apps Script
    ticketId = generateLocalId();
    ticketNumero = null;
    var folderUrl = '';

    var btn = document.getElementById('submitBtn');
    if (photoFiles.length > 0) {
      btn.innerHTML = '‚è≥ Subiendo fotos...';
    } else {
      btn.innerHTML = '‚è≥ Registrando...';
    }

    function encodePhotos(files, callback) {
      if (files.length === 0) { callback([]); return; }
      var results = [];
      var pending = files.length;
      files.forEach(function(file, i) {
        var reader = new FileReader();
        reader.onload = function(e) {
          results[i] = e.target.result;
          pending--;
          if (pending === 0) callback(results);
        };
        reader.readAsDataURL(file);
      });
    }

    encodePhotos(photoFiles, function(fotosBase64) {
      var fullPayload = Object.assign({}, payload, {
        localId: ticketId,
        fotos: fotosBase64
      });

      if (APPS_SCRIPT_URL) {
        fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(fullPayload)
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.id) ticketId = data.id;
          folderUrl = data.folderUrl || '';
          var msg = folderUrl ? '‚úÖ Ticket registrado con ' + fotosBase64.length + ' foto(s) en Drive' : '‚úÖ Registrado en Google Sheets';
          showToast(msg);
          finalizarTicket(payload, ticketId, folderUrl, fotosBase64.length);
        })
        .catch(function() {
          showToast('‚ö†Ô∏è Sin conexi√≥n. Ticket guardado localmente.');
          finalizarTicket(payload, ticketId, '', fotosBase64.length);
        });
      } else {
        finalizarTicket(payload, ticketId, '', fotosBase64.length);
      }
    });

    return; // finalizarTicket handles the rest
    var folderUrl_placeholder = '';
  }

  function finalizarTicket(payload, ticketId, folderUrl, numFotos) {
    var btn = document.getElementById('submitBtn');
    btn.disabled = false;
    btn.innerHTML = '‚ö° Abrir Incidencia';

    var ticket = {
      id: ticketId,
      timestamp: new Date().toISOString(),
      folderUrl: folderUrl,
      numFotos: numFotos
    };
    Object.keys(payload).forEach(function(k) { ticket[k] = payload[k]; });

    var tickets = JSON.parse(localStorage.getItem('sigt_tickets') || '[]');
    tickets.unshift(ticket);
    localStorage.setItem('sigt_tickets', JSON.stringify(tickets.slice(0, 100)));

    showSuccess(ticket);
    currentTicket = ticket;
    navigator.vibrate && navigator.vibrate([100, 50, 100]);
    clearPhotos();
  }

  function showToast(msg) {
    const t = document.createElement('div');
    t.style.cssText = `position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e2d4a;color:#e8edf8;padding:12px 20px;border-radius:12px;font-size:13px;z-index:9999;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,0.4);`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // ‚îÄ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ‚îÄ
  function showSuccess(ticket) {
    document.getElementById('screen2').classList.remove('active');

    const s = document.getElementById('successScreen');
    s.style.display = 'flex';

    const icon = document.getElementById('successIcon');
    icon.className = 'success-icon ' + ticket.priority.toLowerCase();
    icon.textContent = '‚úì';

    document.getElementById('ticketId').textContent = ticket.id;

    const colors = { S1: 'badge-s1', S2: 'badge-s2', S3: 'badge-s3' };

    const summary = document.getElementById('ticketSummary');
    const rows = [
      ['Prioridad', `<span class="${colors[ticket.priority]}">${ticket.priority} ${ticket.priority === 'S1' ? '‚Äî CR√çTICA' : ticket.priority === 'S2' ? '‚Äî ALTA' : '‚Äî NORMAL'}</span>`],
      ['Tipo', `${ticket.categoryIcon} ${ticket.category}`],
      ['Sal√≥n', ticket.salon],
      ['M√°quina', `${ticket.modelo} ¬∑ ${ticket.serie}`],
      ['S√≠ntoma', ticket.sintoma.length > 60 ? ticket.sintoma.substring(0,60)+'‚Ä¶' : ticket.sintoma],
      ['Recaudaci√≥n afectada', ticket.recaudacion === true ? 'üî¥ S√≠' : ticket.recaudacion === false ? 'üü¢ No' : '‚Äî'],
      ['Hora apertura', new Date(ticket.timestamp).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})]
    ];

    summary.innerHTML = rows.filter(function(r){return r!=null;}).map(([k, v]) => `
      <div class="ticket-row">
        <span class="t-key">${k}</span>
        <span class="t-val" style="text-align:right;max-width:60%">${v}</span>
      </div>
    `).join('');

    state.currentStep = 3;
    updateDots();
    window.scrollTo(0, 0);
  }

  function resetForm() {
    // Reset state
    state.priority = null;
    state.category = null;
    state.categoryIcon = null;
    state.recaudacion = null;
    state.currentStep = 1;

    // Reset UI
    document.querySelectorAll('.priority-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('nextBtn1').disabled = true;

    // Reset form
    clearPhotos();
    ['salon', 'modelo', 'serie', 'sintoma', 'errores', 'pasos', 'empleado', 'telPersonal', 'telSala'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('inicio').value = '';
    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));

    document.getElementById('successScreen').style.display = 'none';
    document.getElementById('screen1').classList.add('active');
    updateDots();
    window.scrollTo(0, 0);

    // Restore saved contact data
    resetPhoneFields();
  }

  // ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ
  function showHistory() {
    document.getElementById('screen1').classList.remove('active');
    document.getElementById('screen2').classList.remove('active');
    document.getElementById('successScreen').style.display = 'none';
    document.getElementById('historyScreen').style.display = 'flex';
    document.getElementById('historyScreen').style.flexDirection = 'column';
    document.getElementById('historyScreen').style.gap = '12px';

    const tickets = JSON.parse(localStorage.getItem('sigt_tickets') || '[]');
    document.getElementById('historyCount').textContent = tickets.length + ' incidencia(s)';

    const list = document.getElementById('historyList');
    if (tickets.length === 0) {
      list.innerHTML = '<div class="empty-state"><div class="e-icon">üìã</div><p>Sin incidencias registradas</p></div>';
    } else {
      const colors = { S1: 'var(--s1)', S2: 'var(--s2)', S3: 'var(--s3)' };
      list.innerHTML = tickets.map(t => {
        const d = new Date(t.timestamp);
        const time = d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
        return `
          <div class="ticket-item">
            <div class="t-priority" style="color:${colors[t.priority]}">${t.priority}</div>
            <div class="t-info">
              <div class="t-id">${t.id}</div>
              <div class="t-cat">${t.categoryIcon} ${t.category}</div>
              <div class="t-salon">${t.salon} ¬∑ ${t.modelo}</div>
            </div>
            <div class="t-time">${time}</div>
          </div>
        `;
      }).join('');
    }
  }

  function hideHistory() {
    document.getElementById('historyScreen').style.display = 'none';
    if (state.currentStep === 1) {
      document.getElementById('screen1').classList.add('active');
    } else if (state.currentStep === 2) {
      document.getElementById('screen2').classList.add('active');
    } else {
      document.getElementById('successScreen').style.display = 'flex';
    }
  }


  // ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ
  function showSettings() {
    ['screen1','screen2'].forEach(id => document.getElementById(id).classList.remove('active'));
    document.getElementById('successScreen').style.display = 'none';
    document.getElementById('historyScreen').style.display = 'none';
    const s = document.getElementById('settingsScreen');
    s.style.display = 'flex';
    s.style.flexDirection = 'column';
    s.style.gap = '16px';

    // Load saved URL
    const saved = APPS_SCRIPT_URL;
    document.getElementById('scriptUrlInput').value = saved;
    updateSheetsStatus();
  }

  function hideSettings() {
    document.getElementById('settingsScreen').style.display = 'none';
    if (state.currentStep === 1) document.getElementById('screen1').classList.add('active');
    else if (state.currentStep === 2) document.getElementById('screen2').classList.add('active');
    else document.getElementById('successScreen').style.display = 'flex';
  }

  function saveScriptUrl() {
    const url = document.getElementById('scriptUrlInput').value.trim();
    if (url && !url.startsWith('https://script.google.com/macros/s/')) {
      showToast('‚ö†Ô∏è La URL no parece v√°lida. Debe empezar por https://script.google.com/macros/s/');
      return;
    }
    // URL ya configurada en el c√≥digo

    updateSheetsStatus();
    showToast(url ? '‚úÖ URL guardada correctamente' : 'üóëÔ∏è URL eliminada. Modo local activo.');
  }

  function updateSheetsStatus() {
    const url = APPS_SCRIPT_URL;
    const status = document.getElementById('sheetsStatus');
    const indicator = document.getElementById('sheetsIndicator');
    if (url) {
      status.textContent = 'Configurado ‚úì';
      status.style.color = 'var(--s3)';
      indicator.style.background = 'var(--s3)';
      indicator.style.boxShadow = '0 0 6px var(--s3)';
    } else {
      status.textContent = 'No configurado';
      status.style.color = 'var(--muted)';
      indicator.style.background = 'var(--border)';
      indicator.style.boxShadow = 'none';
    }
  }

  function testConnection() {
    var url = document.getElementById('scriptUrlInput').value.trim();
    if (!url) { showToast('Introduce primero la URL del script'); return; }
    var btn = document.getElementById('testBtn');
    var result = document.getElementById('testResult');
    btn.textContent = 'Probando...';
    btn.disabled = true;
    result.style.display = 'none';

    fetch(url + '?test=1', { method: 'GET', mode: 'no-cors' })
      .then(function() {
        result.style.display = 'block';
        result.style.background = 'var(--s3-dim)';
        result.style.color = 'var(--s3)';
        result.style.border = '1px solid rgba(34,197,94,0.3)';
        result.innerHTML = '‚úÖ URL valida y accesible. Script configurado correctamente.';
        btn.textContent = 'üîå Probar conexion';
        btn.disabled = false;
      })
      .catch(function() {
        result.style.display = 'block';
        result.style.background = 'var(--s1-dim)';
        result.style.color = 'var(--s1)';
        result.style.border = '1px solid rgba(239,68,68,0.3)';
        result.innerHTML = '‚ùå No se puede acceder a la URL. Comprueba tu conexion a internet.';
        btn.textContent = 'üîå Probar conexion';
        btn.disabled = false;
      });
  }

  // Init sheets status on load
  window.addEventListener('load', updateSheetsStatus);


  // ‚îÄ‚îÄ‚îÄ PHOTO HANDLING ‚îÄ‚îÄ‚îÄ
  let photoFiles = [];

  function handlePhotos(input) {
    const files = Array.from(input.files);
    const remaining = 4 - photoFiles.length;
    const toAdd = files.slice(0, remaining);
    toAdd.forEach(file => {
      if (file.type.startsWith('image/')) {
        photoFiles.push(file);
      }
    });
    input.value = '';
    renderPhotoGrid();
  }

  function renderPhotoGrid() {
    const grid = document.getElementById('photoGrid');
    const placeholder = document.getElementById('photoPlaceholder');
    const area = document.getElementById('photoUploadArea');

    if (photoFiles.length === 0) {
      grid.style.display = 'none';
      placeholder.style.display = 'flex';
      area.classList.remove('has-photos');
      return;
    }

    grid.style.display = 'grid';
    placeholder.style.display = 'none';
    area.classList.add('has-photos');

    grid.innerHTML = photoFiles.map((f, i) => {
      const url = URL.createObjectURL(f);
      return `<div class="photo-thumb">
        <img src="${url}" alt="Foto ${i+1}">
        <button class="remove-photo" onclick="event.stopPropagation();removePhoto(${i})">‚úï</button>
      </div>`;
    }).join('');

    // Show count
    const existing = document.getElementById('photoCountBadge');
    if (existing) existing.remove();
    if (photoFiles.length > 0) {
      const badge = document.createElement('div');
      badge.id = 'photoCountBadge';
      badge.className = 'photo-count-badge';
      badge.innerHTML = `üì∏ ${photoFiles.length} foto${photoFiles.length > 1 ? 's' : ''} adjunta${photoFiles.length > 1 ? 's' : ''}`;
      area.parentNode.insertBefore(badge, area.nextSibling.nextSibling);
    }
  }

  function removePhoto(index) {
    photoFiles.splice(index, 1);
    renderPhotoGrid();
  }

  function clearPhotos() {
    photoFiles = [];
    renderPhotoGrid();
    const badge = document.getElementById('photoCountBadge');
    if (badge) badge.remove();
  }

  function fotosToBase64() {
    return Promise.all(photoFiles.map(f => new Promise((res) => {
      const r = new FileReader();
      r.onload = e => res(e.target.result);
      r.readAsDataURL(f);
    })));
  }



  // ‚îÄ‚îÄ‚îÄ SETTINGS PASSWORD ‚îÄ‚îÄ‚îÄ
  const SETTINGS_CODE = '2633886trastamarawitty@darkcrystalespa√±a';
  let settingsPwAttempts = 0;
  let settingsPwLock = 0;

  function checkSettingsPassword() {
    const now = Date.now();
    if (settingsPwLock > now) {
      const mins = Math.ceil((settingsPwLock - now) / 60000);
      showToast('üîí Bloqueado ' + mins + ' min por intentos fallidos');
      return;
    }
    document.getElementById('settingsModal').style.display = 'flex';
    document.getElementById('settingsPasswordInput').value = '';
    document.getElementById('settingsPasswordError').textContent = '';
    setTimeout(() => document.getElementById('settingsPasswordInput').focus(), 100);
  }

  function verifySettingsPassword() {
    const input = document.getElementById('settingsPasswordInput').value;
    if (input === SETTINGS_CODE) {
      settingsPwAttempts = 0;
      closeSettingsModal();
      showSettings();
    } else {
      settingsPwAttempts++;
      if (settingsPwAttempts >= 3) {
        settingsPwLock = Date.now() + 10 * 60 * 1000;
        settingsPwAttempts = 0;
        closeSettingsModal();
        showToast('üîí Acceso bloqueado 10 minutos');
      } else {
        const left = 3 - settingsPwAttempts;
        document.getElementById('settingsPasswordError').textContent = 'C√≥digo incorrecto ¬∑ ' + left + ' intento' + (left > 1 ? 's' : '') + ' restante' + (left > 1 ? 's' : '');
        document.getElementById('settingsPasswordInput').value = '';
        document.getElementById('settingsPasswordInput').focus();
      }
    }
  }

  function closeSettingsModal() {
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('settingsPasswordInput').value = '';
    document.getElementById('settingsPasswordError').textContent = '';
  }

  // ‚îÄ‚îÄ‚îÄ PHONE MANAGEMENT ‚îÄ‚îÄ‚îÄ
  function initPhones() {
    const telP = localStorage.getItem('sigt_tel_personal') || '';
    const telS = localStorage.getItem('sigt_tel_sala') || '';
    const emp  = localStorage.getItem('sigt_empleado') || '';

    if (telP) {
      document.getElementById('telPersonal').value = telP;
      document.getElementById('telPersonalGuardado').textContent = '‚úì Guardado';
    }
    if (telS) {
      document.getElementById('telSala').value = telS;
      document.getElementById('telSalaGuardado').textContent = '‚úì Guardado';
    }
    if (emp) {
      document.getElementById('empleado').value = emp;
    }
  }

  function guardarTelPersonal() {
    const val = document.getElementById('telPersonal').value.trim();
    if (!val) return;
    localStorage.setItem('sigt_tel_personal', val);
    document.getElementById('telPersonalGuardado').textContent = '‚úì Guardado';
    showToast('üì± Tel√©fono personal guardado');
    navigator.vibrate && navigator.vibrate(40);
  }

  function guardarTelSala() {
    const val = document.getElementById('telSala').value.trim();
    if (!val) return;
    localStorage.setItem('sigt_tel_sala', val);
    document.getElementById('telSalaGuardado').textContent = '‚úì Guardado';
    showToast('üìû Tel√©fono de sala guardado');
    navigator.vibrate && navigator.vibrate(40);
  }

  function resetPhoneFields() {
    const telP = localStorage.getItem('sigt_tel_personal') || '';
    const telS = localStorage.getItem('sigt_tel_sala') || '';
    const emp  = localStorage.getItem('sigt_empleado') || '';
    document.getElementById('telPersonal').value = telP;
    document.getElementById('telSala').value = telS;
    document.getElementById('empleado').value = emp;
    document.getElementById('telPersonalGuardado').textContent = telP ? '‚úì Guardado' : '';
    document.getElementById('telSalaGuardado').textContent = telS ? '‚úì Guardado' : '';
  }

  // ‚îÄ‚îÄ‚îÄ PWA INSTALL ‚îÄ‚îÄ‚îÄ
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    const banner = document.getElementById('installBanner');
    banner.style.display = 'flex';
    document.getElementById('installBtn').onclick = function() {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(function() {
        banner.style.display = 'none';
      });
    };
  });

  // ‚îÄ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ‚îÄ
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // ‚îÄ‚îÄ‚îÄ PIN TOUCH HANDLERS ‚îÄ‚îÄ‚îÄ
  function handlePinTouch(e, n) {
    e.preventDefault();
    const btn = e.currentTarget;
    btn.classList.add('pressed');
    setTimeout(() => btn.classList.remove('pressed'), 150);
    pinInput(n);
  }

  function handlePinClearTouch(e) {
    e.preventDefault();
    const btn = e.currentTarget;
    btn.classList.add('pressed');
    setTimeout(() => btn.classList.remove('pressed'), 150);
    pinClear();
  }

  // ‚îÄ‚îÄ‚îÄ PIN PROTECTION ‚îÄ‚îÄ‚îÄ
  const CORRECT_PIN = '2906'; // Cambia este PIN
  const MAX_ATTEMPTS = 5;
  const LOCK_MINUTES = 10;

  let pinBuffer = '';
  let attempts = parseInt(sessionStorage.getItem('sigt_attempts') || '0');
  let lockUntil = parseInt(localStorage.getItem('sigt_lock') || '0');

  function initLogin() {
    const session = sessionStorage.getItem('sigt_auth');
    if (session === 'ok') {
      document.getElementById('loginScreen').style.display = 'none';
      return;
    }
    checkLock();
  }

  function checkLock() {
    const now = Date.now();
    if (lockUntil > now) {
      const mins = Math.ceil((lockUntil - now) / 60000);
      document.getElementById('lockMsg').textContent = 'üîí Bloqueado ' + mins + ' min';
      document.querySelectorAll('.pin-key').forEach(k => k.disabled = true);
    } else {
      document.getElementById('lockMsg').textContent = '';
      document.querySelectorAll('.pin-key').forEach(k => k.disabled = false);
    }
  }

  function pinInput(n) {
    if (lockUntil > Date.now()) { checkLock(); return; }
    if (pinBuffer.length >= 4) return;
    pinBuffer += n;
    updatePinDots();
    if (pinBuffer.length === 4) {
      setTimeout(checkPin, 150);
    }
  }

  function pinClear() {
    pinBuffer = pinBuffer.slice(0, -1);
    updatePinDots();
    document.getElementById('pinError').textContent = '';
  }

  function updatePinDots() {
    for (let i = 0; i < 4; i++) {
      const d = document.getElementById('pd' + i);
      d.classList.toggle('filled', i < pinBuffer.length);
      d.classList.remove('error');
    }
  }

  function checkPin() {
    if (pinBuffer === CORRECT_PIN) {
      sessionStorage.setItem('sigt_auth', 'ok');
      sessionStorage.setItem('sigt_attempts', '0');
      attempts = 0;
      document.getElementById('loginScreen').style.display = 'none';
    } else {
      attempts++;
      sessionStorage.setItem('sigt_attempts', attempts);
      // Shake dots red
      for (let i = 0; i < 4; i++) {
        document.getElementById('pd' + i).classList.add('error');
      }
      const remaining = MAX_ATTEMPTS - attempts;
      if (attempts >= MAX_ATTEMPTS) {
        lockUntil = Date.now() + LOCK_MINUTES * 60000;
        localStorage.setItem('sigt_lock', lockUntil);
        attempts = 0;
        sessionStorage.setItem('sigt_attempts', '0');
        document.getElementById('pinError').textContent = '';
        checkLock();
      } else {
        document.getElementById('pinError').textContent = 'PIN incorrecto ¬∑ ' + remaining + ' intentos restantes';
      }
      setTimeout(() => {
        pinBuffer = '';
        updatePinDots();
      }, 600);
    }
  }

  // Auto-logout tras 30 min inactividad
  let inactivityTimer;
  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      sessionStorage.removeItem('sigt_auth');
      location.reload();
    }, 30 * 60 * 1000);
  }
  document.addEventListener('touchstart', resetInactivity);
  document.addEventListener('click', resetInactivity);

  window.addEventListener('load', () => { initLogin(); resetInactivity(); });

</script>

  <!-- SETTINGS PASSWORD MODAL -->
  <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(6,11,24,0.95);z-index:9998;align-items:center;justify-content:center;padding:32px;">
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:28px;width:100%;max-width:340px;display:flex;flex-direction:column;gap:16px;">
      <div style="text-align:center;">
        <div style="font-size:32px;margin-bottom:8px;">üîê</div>
        <div style="font-size:18px;font-weight:800;">Acceso a Ajustes</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px;">Introduce el codigo de administrador</div>
      </div>
      <div class="field">
        <input type="password" id="settingsPasswordInput" placeholder="Codigo de acceso" 
          style="text-align:center;letter-spacing:2px;font-size:16px;"
          onkeydown="if(event.key==='Enter') verifySettingsPassword()">
      </div>
      <div id="settingsPasswordError" style="text-align:center;font-size:12px;color:var(--s1);min-height:16px;"></div>
      <div style="display:flex;gap:10px;">
        <button class="new-btn" onclick="closeSettingsModal()" style="flex:1;">Cancelar</button>
        <button class="submit-btn" onclick="verifySettingsPassword()" style="flex:2;padding:14px;">Entrar</button>
      </div>
    </div>
  </div>

</body>
</html>
